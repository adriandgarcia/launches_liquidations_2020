---
title: "Shareclass Activity 2020"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Adrian D. Garcia"
date: "January 2020"
output:
  html_document:
    toc: true
    toc_float: true
---

# Intro

## Getting Started

```{r setup, message = FALSE, warning = FALSE}

library(tidyverse) #For Data Analysis
library(lubridate) #For working with dates
library(DT) #For visualizing tables

```

Data pulled from Morningstar Direct on Jan. XX, 2020. Files combined using _combine_files.r_. 
Data in M* filtered:

* != Fund of funds: Yes
* != Morningstar Category: Money Market - Non-40 ACT
* != Morningstar Category: Money Market - Taxable
* != Morningstar Category: Money Market - Taxfree

56,270 rows, 36 columns

Added column _Obsolete_ to indicate if share class is obsolete. I assume a blank Obsolete..Date means the share class still exists.

Data filtered to remove the "Load Waived" Share.Class.Type.
49,3337 rows, 37 columns


```{r load, message = FALSE}

Full <- read_csv("data_combined.csv",
                 guess_max = 20000) %>% 
  rename_all(make.names) %>% 
  mutate(Obsolete =
           case_when(
             !is.na(Obsolete..Date) ~ "Obsolete",
             TRUE ~ "Active"
           )) %>% 
  filter(Share.Class.Type != "Load Waived" |
           is.na(Share.Class.Type))

# Full_uniq <- vector("double", ncol(Full))
# names(Full_uniq) <- names(Full)
# for (i in names(Full)) {
#   Full_uniq[i] <- n_distinct(Full[[i]])
# }

```

# Overview

```{r graph_overview, echo=FALSE}

ggplot(data = Full, mapping = aes(x = year(Inception..Date), fill = Obsolete)) +
  geom_bar(position = "stack") +
  ggtitle("Fund Launches") +
  ylab("Count") +
  xlab("YEAR") +
  theme_classic() +
  theme(plot.title = element_text(size = 11, face = "bold"))

```

## Net Count

There was a large drop off in launches in 2020 compared to recent years. However it appears rationalization continued at roughly the same levels as recent years.

Of 56,720 fund share classes examined there are inception dates missing for 84.

```{r data_overview, message=FALSE}

Year_Count <- function(x, colz){
   Full %>% 
   mutate(Year = year(x)) %>% 
  group_by_at(colz) %>% 
  summarise(Count = n(), .groups = "drop") %>% 
  arrange(desc(Year))
 }

inception_year <- Year_Count(Full$Inception..Date, colz = c("Year"))
obsolete_year <- Year_Count(Full$Obsolete..Date, colz = c("Year"))

merge_type <- Year_Count(Full$Obsolete..Date, colz = c("Year", "Obsolete..Type"))

Net_Count <- full_join(inception_year, obsolete_year, by = "Year", suffix = c("_inception", "_obsolete")) %>% 
  select(-contains("pct_change")) %>% 
  group_by(Year) %>% 
  mutate(Net_Count = sum(Count_inception, -Count_obsolete, na.rm = TRUE))

datatable(Net_Count)

```

## Liquidations

```{R obsolete_type, echo = FALSE}

ggplot(data = merge_type, mapping = aes(x =Year, y = Count, fill = Obsolete..Type)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_y_continuous(limits = c(0, 2500)) +
  coord_flip() +
  ggtitle("Fund Liquidations") +
  ylab("Count") +
  xlab("YEAR") +
  theme_classic() +
  theme(plot.title = element_text(size = 11, face = "bold"))

merge_type %>% 
  filter(!is.na(Year)) %>% 
  pivot_wider(names_from = Obsolete..Type, values_from  = Count) %>% 
  datatable()

```


## New Funds

```{r new_funds, message=FALSE}

New_Funds <- Full %>% 
  filter(Oldest..Share.Class == "Yes") %>% 
   mutate(Year = year(Inception..Date)) %>% 
  group_by(Year, Index..Fund) %>% 
  summarise(Count = n(), .groups = "drop") %>% 
  mutate(
    Pct_Change = round(
      ((Count/lag(Count) - 1) * 100),
      1
    )) %>% 
  arrange(desc(Year))

```


```{r new_funds_graphs, echo=FALSE}

ggplot(data = New_Funds, mapping = aes(x =Year, y=Count, color=Index..Fund)) +
  geom_line() +
  ggtitle("New Fund Launches") +
  ylab("Count") +
  xlab("YEAR") +
  theme_classic() +
  theme(plot.title = element_text(size = 11, face = "bold"))

New_Funds %>% 
  select(-Pct_Change) %>% 
  pivot_wider(names_from = Index..Fund, values_from = Count) %>%
  rename(
    Passive = Yes,
    Active = No
    ) %>% 
  group_by(Year) %>% 
  mutate(total = sum (Active, Passive, na.rm = TRUE)) %>% 
    datatable()

```

# Companies

To look at which firms cut or added share classes I first clean up the company names with Branding.Names.Mod. 

```{r companies, message=FALSE}

company_count <- function(x, colz){
   Full %>% 
  mutate(
    Year = year(x),
    Branding.Name.Mod =
    case_when(
      grepl("State Street", Branding.Name) ~ "State Street",
      grepl("TIAA", Branding.Name) ~ "TIAA/Nuveen",
      grepl("Nuveen", Branding.Name) ~ "TIAA/Nuveen",
      grepl("Eaton Vance", Branding.Name) ~ "Eaton Vance/Calvert",
      grepl("Calvert", Branding.Name) ~ "Eaton Vance/Calvert",
      grepl("iShares", Branding.Name) ~ "iShares/BlackRock",
      grepl("BlackRock", Branding.Name) ~ "iShares/BlackRock",
      grepl("PowerShares", Branding.Name) ~ "PowerShares/Invesco",
      grepl("Invesco", Branding.Name) ~ "PowerShares/Invesco",
      grepl("DWS$", Branding.Name) ~ "DWS/Xtrackers",
      grepl("Xtrackers", Branding.Name) ~ "DWS/Xtrackers",
      TRUE ~ Branding.Name)) %>% 
      group_by_at(colz) %>% 
      summarise(Count = n()) %>% 
    ungroup() %>% 
    arrange(desc(Year))
   }

comp_inception <- company_count(Full$Inception..Date, colz = c("Branding.Name.Mod", "Year"))
comp_obsolete <- company_count(Full$Obsolete..Date, colz = c("Branding.Name.Mod", "Year"))

comp_new_funds <- company_count(Full$Inception..Date, colz = c("Branding.Name.Mod", "Year", "Oldest..Share.Class")) %>% 
  filter(Oldest..Share.Class == "Yes")

comp_old_funds <- company_count(Full$Obsolete..Date, colz = c("Branding.Name.Mod", "Year", "Oldest..Share.Class")) %>% 
  filter(Oldest..Share.Class == "Yes")

top_launchers <-
  
comp_rank <- function(x){
  x %>%  filter(Year == "2020") %>% 
  mutate(Rank = rank(-Count)) %>% 
  filter(Rank <=20) %>% 
    arrange(Rank)
}

top_cutters <- comp_rank(comp_obsolete)
top_old_cutters <-  comp_rank(comp_old_funds)

top_launchers <- comp_rank(comp_inception)
top_new_launchers <- comp_rank(comp_new_funds)

```

## Top Launchers

(Share Class)

```{r launchers, echo=FALSE}

datatable(top_launchers)

```

## Top New Fund Launchers

(Oldest Share Class)

```{r new_launchers, echo=FALSE}

datatable(top_new_launchers)

```


## Top Cutters

(Share Class)

```{r cutters, echo=FALSE}

datatable(top_cutters)

```

## Top Fund Cutters

(Oldest Share Class)

```{r old_cutters, echo=FALSE}

datatable(top_old_cutters)

```

# Share Class Overview

```{r share_class_overview, message=FALSE}

simp_count <- function(x, colz){
  Full %>%  
  mutate(Year = year(x)) %>% 
    group_by_at(colz) %>% 
    count(name = "Count")
  }

share_class_add_count <- simp_count(Full$Inception..Date, colz = c("Year", "Share.Class.Type"))

```

From Morningstar Direct

```{r share_class_overview_graphic, echo=FALSE}

ggplot(data = share_class_add_count, aes(x = Year, y = Count, fill = Share.Class.Type)) +
  geom_bar(stat = "identity") + 
  scale_y_continuous(breaks = seq.int(from = 1900, to = 2020, by = 20)) +
  facet_wrap(~Share.Class.Type, scales = "free_y") +
  ggtitle("New Fund Launches (Share Class Type") +
  ylab("Count") +
  xlab("YEAR") +
  theme_classic() +
  theme(plot.title = element_text(size = 11, face = "bold"))
```

## 2020

```{r share_class_2020, echo=FALSE}

share_class_add_count  %>% 
  filter(Year == "2020") %>% 
  arrange(desc(Count)) %>% 
  datatable()

```

## TK

```{r share_clas_view, echo=FALSE}

#The data from Morningstar is dirty. This pattern pulls the last letters/digits in the mutual fund name to identify the share class.

PATTERN <-
  c(
    "(\\s)?([:alnum:]+)?([:alnum:][:punct:][:alnum:] LW)?( Load Waived)?( LW)?([:punct:]+)?([:alnum:]+)?(-[:alnum:])?(â„¢)?([:alpha:]\\{..\\} LW)?([:punct:]..[:punct:])?(\\s)?([:punct:][:alpha:]+[:punct:])?$"
  )

#The data from Morningstar is dirty. This pattern refines the pattern above to identify the share class.

CUT <-
  c(
    "([:punct:]\\X\\X[:punct:])|([:punct:]\\X\\X$)|(-)|(\\sLW)|(\\sLoad\\sWaived)|(\\([:alpha:]+\\))"
  )

#The data from Morningstar is dirty. This pattern makes manual changes to share classification for when the patterns above failed.

CHANGE <- c(
  "^Adm(in$)?(in[:alpha:]+)?$" = "Admin",
  "[:alnum:]+R6$" = "R6",
  "(?!AA)[:alpha:]+A$" = "A",
  "A\\{m" = "A",
  "([:alpha:]+)([:punct:])?([:alpha:]+)?A$" = "A",
  "(?![FIVS]+I$|([:alpha:]+)?II$)([:alpha:]+)?I$(?<!(IR$))" = "I",
  "([:alpha:]+)([:punct:])?([:alpha:]+)?I$(?<!(F/I$))" = "I",
  "([:alpha:]+)([:punct:])?([:alpha:]+)?C$" = "C",
  "PlusC([:digit:]+)$" = "C",
  "([:alpha:]+)?([:Punct:][:alpha:]+)?Inst(l$)?(itutional$)?$" = "Instl",
  "([:alnum:]+)?Ins$" = "Instl",
  "([:alnum:]+)?Insl$" = "Instl",
  "[:alnum:]+Ist$" = "Instl",
  "([:alpha:]+)?([:punct:])?([:alpha:]+)?Y$" = "Y",
  "([:alpha:]+)?([:punct:])?([:alpha:]+)?R$(?<!(SDR$)|(IR$))" = "R",
  "[:alnum:]+R5$" = "R5",
  "([:alpha:]+)?([:Punct:][:alpha:]+)?In([vest]+)?(ment$)?$(?<!(Int$))" = "Investor",
  "([:alpha:]+)?([:punct:])?([:alpha:]+)?N$" = "N",
  "([:alpha:]+)?([:punct:])?([:alpha:]+)?T$" = "T",
  "[:alnum:]+R4$" = "R4",
  "([:alpha:]+)?([:Punct:][:alpha:]+)?Adv(iser$)?(isory$)?$" = "Advisor",
  "([:alpha:]+)?([:Punct:][:alpha:]+)?ADV$" = "Advisor",
  "([:alpha:]+)?([:punct:])?([:alpha:]+)?K$" = "K",
  "([:alpha:]+)?([:punct:])?([:alpha:]+)?F$" = "F",
  "[:alnum:]+R3$" = "R3",
  "[:alnum:]+F3$" = "F3",
  "([:alpha:]+)?([:punct:])?([:alpha:]+)?IS$" = "IS",
  "^I$" = "Instl",
  "Retire(ment)?$" = "R"
)


#Using the above patterns we can clean the share class information
#Name -> Extract -> New -> Revision

INC_Data <- Full %>%
  select(Name) %>%
  mutate(
    Match = str_detect(Name, PATTERN),
    EXTRACT = str_extract(Name, PATTERN),
    New = str_trim(str_replace_all(EXTRACT,  CUT, "")),
    Revision = str_replace_all(New, CHANGE)
    )

#This shows how the names were altered to create the final share class informatin (Revision)
#The revision counts might be inaccurate.
INC_Changes <- INC_Data %>%
  group_by(EXTRACT) %>%
  summarise(cases = n()) %>%
  mutate(New = str_trim(str_replace_all(EXTRACT,  CUT, ""))) %>% group_by(New) %>%
  mutate(replacements = n() - 1,
         newcases = sum(cases)) %>%
  mutate(Revision = str_replace_all(New, CHANGE)) %>%
  group_by(Revision) %>%
  mutate(replacements1 = (n() - replacements) - 1,
         newercases = sum(cases))

#This counts the number of share class types in the data
INC_Summary <- INC_Data %>%
  group_by(Revision) %>%
  summarise(cases = n()) %>%
  arrange(-cases)

INC_MODIFIED <- INCEPTION %>%
  mutate(
    Match = str_detect(Name, PATTERN),
    EXTRACT = str_extract(Name, PATTERN),
    New = str_trim(str_replace_all(EXTRACT,  CUT, "")),
    Revision = str_replace_all(New, CHANGE),
    `Obsolete Year` = year(`Obsolete Date`),
    `Obsolete Month` = month(`Obsolete Date`),
    `Inception Year` = year(`Inception Date...4`),
    `Inception Month` = month(`Inception Date...4`)
  ) %>%
  select(Name, 
         Match, 
         EXTRACT, 
         New, 
         Revision, 
         2:3,
         `Obsolete Month`,
         `Obsolete Year`, 
         4, 
         `Inception Month`, 
         `Inception Year`, 
         5:22)

```